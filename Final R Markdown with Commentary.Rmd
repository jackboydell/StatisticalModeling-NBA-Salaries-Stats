---
title: "Final Project: Appendices"
author: "Jack Boydell"
date: "12/3/2019"
output: html_document
---

### 5.0a Appendix: NBA Statistics and Salaries
```{r}
library(tidyverse)
library(tidyr)
library(leaps)
library(tree)
library(randomForest)
library(GGally)
```

Packages required to run R code and analysis. 


```{r}
salary<-read.csv("NBA_season1718_salary (1).csv", header=TRUE, 
                 stringsAsFactors = FALSE)
head(salary)

player_stats<-read.csv("nba_extra2.csv", header=TRUE, 
                       stringsAsFactors = FALSE)
head(player_stats)
summary(player_stats)
```

Loading and labeling of the two datasets that will be manipulated and joined to create the final dataset that will be used in the NBA Statistics and Salaries analysis.


```{r}
player_stats2<-player_stats%>%
  filter(is.na(Rk)==FALSE)

head(player_stats2)
player_stats3 <- player_stats2[-c(24, 25, 28, 29, 45, 46, 59, 60, 68, 69, 70, 73, 74, 77, 78, 97, 98, 102, 103, 118, 119, 122, 123, 142, 143, 145, 146, 167, 168, 174, 175, 180, 181, 190, 191, 202, 203, 229, 230, 237, 238, 242, 243, 250, 251, 252, 259, 260, 266, 267, 276, 277, 288, 289, 299, 300, 306, 307, 314, 315, 319, 320, 328, 329, 331, 332, 342, 342, 343, 344, 368, 369, 386, 387, 401, 402, 419, 420, 425, 426, 427, 439, 440, 442, 443, 450, 451, 454, 455, 471, 472, 481, 482, 493, 494, 496, 497, 523, 524, 535, 536, 550, 551, 568, 569, 585, 586, 602, 603, 604, 606, 607, 610, 611, 623, 624, 642, 643, 650, 651, 660, 661),]
head (player_stats3)
```

Due to the format of the Kaggle data set "nba_extra2" accounting for certain players playing for multiple teams in one year (trades, free-agent signings,etc). Some players for example orginially had three rows or sets of oberservations: one for each team they played for and a total row (the two separate team stats together). These instances were manually identified and removed using this section of code. After this procedure, each NBA player only had one row/set of observations that accounts for his total statistics from that season. 


```{r}
playerS<-separate(data=player_stats3,col=Player,into=c("Player", "nickname"), sep=":")
head(playerS)
```

In this section of code the separate function is used to separate the "Player" and "nickname" by ':' so the two datasets can be joined by the similar column of "Player" each player's full name.


```{r}
data<-left_join(playerS, salary)
data<-data%>%
  mutate(MPG = MP/G, PPG = PTS/G, APG = AST/G, RPG = TRB/G, TOG = TOV/G, GSR = GS/G)
data<-na.omit(data)
attach(data)
```

This section of code joins "playerS" and "salary" using the left_join function and creates the per game basis metrics using the mutata function. Na.omit works to removed any empty values (NAs) from the dataset. 


```{r}
data.pure <- data
data.pure$Player <- data.pure$nickname <- data.pure$Tm <- data.pure$Pos <- data.pure$Rk <- data.pure$X <- NULL
```

The final dataset titled data is copied and any non-numerical or unimportant variable is removed. This allows for no confusion in later outputs of pairs correlation plots and puts a focus on the statisitics that will be used in analysis. 

```{r}
stats_salary_cor <- data %>%
  select(season17_18, PTS, TOV, PPG, MPG, TOG, RPG, APG, GSR, GS, Age)
ggpairs(stats_salary_cor)
cor(stats_salary_cor)[,"season17_18"]
```

A pairs correlation plot is created to highlight any initial correlation betwen 2017-2018 season salaries adn certain basketball performance statistics. 


```{r}
### importance plot with Random Forest
set.seed(1)
train<-sample(1:nrow(data.pure), nrow(data.pure)/2)
NBA.test <- data.pure[-train, "season17_18"]
rf.NBA<-randomForest(season17_18~., data=data.pure, subset=train, 
                     importance=TRUE)
yhat.rf<-predict(rf.NBA, newdata=data.pure[-train,])
mean((yhat.rf-NBA.test)^2)

importance(rf.NBA)
varImpPlot(rf.NBA)
```

Using the randomForest package, a training subset is taken from the data.pure dataset and applied to produce a variable importance plot (discussed in body of the report).


```{r}
### tree with cross validation for pruning
set.seed(1)
train<-sample(1:nrow(data.pure), nrow(data.pure)/2)
NBA.test <- data.pure[-train, "season17_18"]
tree.NBA<-tree(season17_18~., data.pure, subset=train)
summary(tree.NBA)

plot(tree.NBA)
text(tree.NBA, pretty = 0)
```

The same train subset is created and applied to the tree algorithim to create the recursive binary spltting diagram (discussed in body of the report).


```{r}
cv.NBA<-cv.tree(tree.NBA)
plot(cv.NBA$size, cv.NBA$dev, type='b')

prune.NBA<-prune.tree(tree.NBA, best=4)
plot(prune.NBA)
text(prune.NBA, pretty=0)
```

Cross-validation for the number of terminal nodes(4) is performed and used in coordination with the prune.tree function is modify the tree plot. 


```{r}
mod1a <- lm(season17_18~MPG, data = data.pure)
anova(mod1a)
# RSS = 1.4034e+16

mod1b <- lm(season17_18~PPG, data = data.pure)
anova(mod1b)
# RSS = 1.2803e+16

mod1c <- lm(season17_18~Age, data = data.pure)
anova(mod1c)
# RSS = 1.8605e+16

mod1d <- lm(season17_18~GS, data = data.pure)
anova(mod1d)
# RSS = 1.3925e+16

mod1e <- lm(season17_18~GSR, data = data.pure)
anova(mod1e)
#RSS = 1.3041e+16

mod1e <- lm(season17_18~TOG, data = data.pure)
anova(mod1e)
# RSS = 1.5474e+16 
```

First step of forward selection: testing each explanatory variable in a simple regression format and comaring residual sum of squares (RSS). PPG determined to be the first variable in the model.


```{r}
mod2a <- lm(season17_18~PPG + Age, data = data.pure)
anova(mod2a)
# RSS = 1.078e+16

mod2b <- lm(season17_18~PPG + GSR, data = data.pure)
anova(mod2b)
# RSS = 1.1779e+16

mod2c <- lm(season17_18~PPG + MPG, data = data.pure)
anova(mod2c)
# RSS = 1.2722e+16

mod2d <- lm(season17_18~PPG + GS, data = data.pure)
anova(mod2d)
# RSS = 1.2045e+16

mod2e <- lm(season17_18~PPG + TOG, data = data.pure)
anova(mod2e)
# TOG not significant
```

Second step of forward selection: Age determined to be the second vairable in the model.


```{r}
mod3a <- lm(season17_18~PPG + Age + GSR, data = data.pure)
anova(mod3a)
#RSS = 9.8925e+15

mod3b <- lm(season17_18~PPG + Age + MPG, data = data.pure)
anova(mod3b)
# MPG not significant

mod3c <- lm(season17_18~PPG + Age + GS, data = data.pure)
anova(mod3c)
# RSS = 1.0108e+16

mod3d <- lm(season17_18~PPG + Age + TOG, data = data.pure)
anova(mod3d)
# TOG not significant
```

Third step of forward selection: GSR is determined to be the third variable in the model. 


```{r}
mod4a <- lm(season17_18~PPG + Age + GSR + MPG, data = data.pure)
anova(mod4a)
# MPG not significant

mod4b <- lm(season17_18~PPG + Age + GSR + GS, data = data.pure)
anova(mod4b)
# GS not significant

mod4c <- lm(season17_18~PPG + Age + GSR + TOG, data = data.pure)
anova(mod4c)
# TOG not significant 
```

Fourth step of forward selection: No other variables determined to be significant


```{r}
set.seed(52)
data[sample(nrow(data),1),]

final.model <- lm(season17_18~PPG + Age +GSR, data = data.pure)
anova(final.model)

new.data<- data.frame(PPG = 13.2, Age = 25, GSR = 1)

final.test <- predict(final.model, new.data)
final.test
```

This code takes a random sample for one row/player from the data set and uses the predict function to input Allen Crabbe's stats to createsalary output.


### 5.0b Appendix: College/International and NBA Statistics
```{r}
firstQT<-data%>%
  filter(season17_18<1465920)
dim(firstQT)
set.seed(1)
samp1<-sample(121, 10)
sampFirst<-firstQT[samp1,]

secondQT<-data%>%
  filter(season17_18>=1465920 & season17_18<3028410)
dim(secondQT)
set.seed(2)
samp2<-sample(122, 10)
sampSecond<-secondQT[samp2,]

thirdQT<-data%>%
  filter(season17_18>=3028410 & season17_18<9539057)
dim(thirdQT)
set.seed(3)
samp3<-sample(122, 10)
sampThird<-thirdQT[samp3,]

fourthQT<-data%>%
  filter(season17_18>=9539097 & season17_18<=34682550)
dim(fourthQT)
set.seed(4)
samp4<-sample(122, 10)
sampFourth<-fourthQT[samp4,]
```

This set of code performs a stratified sample based on the five number summary of the overall dataset (all the players' salaries in the NBA during the 2017-2018 season) to create four stratas based on salary in dollar amounts. The results of each strata were used to separately research and create a dataframe with thses 40 players (10 from each strata). This new dataset will be used for regression analysis.


```{r}
college.data <- read.csv("Stratified Sample_NBA stats_Sheet1.csv", header = TRUE,
                         stringsAsFactors = FALSE)
head(college.data)

college<-read.csv("Stat Project_College_International Data_Sheet1.csv", header=TRUE, stringsAsFactors = FALSE)
head(college)
```

Loading and labeling of the two data sets that will be used in the College and NBA statistics analysis. 


```{r}
pro.college <- left_join(college.data, college)
pro.college<-pro.college%>%
  mutate(MPG = MP/G, PPG = PTS/G, APG = AST/G, RPG = TRB/G, TOG = TOV/G)
pro.college <- na.omit(pro.college)
head(pro.college)
```

This section of code joins "college.data" and "college" by the Player column using the left_join function and creates the per game basis metrics using the mutata function. Na.omit works to removed any empty values (NAs) from the dataset.


```{r}
pro.college <- na.omit(pro.college)
pro.college.pure <- pro.college
pro.college.pure$Player <- pro.college.pure$Tm <- pro.college.pure$Team <- pro.college.pure$Pos <- NULL
```

The final dataset titled data is copied and any non-numerical or unimportant variable is removed. This allows for no confusion in later outputs of pairs correlation plots and puts a focus on the statisitics that will be used in analysis. 


```{r}
stats_college_cor <- pro.college %>%
  select(MPG, cMPG, cPPG, cFGA, cFGp, cAPG, cRPG, cFGM)
ggpairs(stats_college_cor)
cor(stats_college_cor)[,"MPG"]
```

A pairs correlation plot is created to highlight any initial correlation betwen MGP in the 2017-2018 NBA season and certain basketball performance statistics from the college or international season prior to entering the league.


```{r}
set.seed(2)
train<-sample(1:nrow(pro.college.pure), nrow(pro.college.pure)/2)
set.seed(2)
rf.College<-randomForest(MPG~cMPG+cRPG+cPPG+cAPG+cFGM+cFGA+cFGp, data=pro.college.pure, subset=train, 
                     importance=TRUE)
yhat.rf<-predict(rf.College, newdata=pro.college.pure[-train,])
mean((yhat.rf-NBA.test)^2)

importance(rf.College)
varImpPlot(rf.College)
```

Using the randomForest package, a training subset is taken from the pro.college.pure dataset and applied to produce a variable importance plot (discussed in body of the report).


```{r}
College.test <- data.pure[-train, "MPG"]
tree.College<-tree(MPG~cMPG+cRPG+cPPG+cAPG+cFGM+cFGA+cFGp, pro.college.pure, subset=train)
summary(tree.College)

plot(tree.College)
text(tree.College, pretty = 0)
cv.College<-cv.tree(tree.College)
plot(cv.College$size, cv.College$dev, type='b')
```

This code sets a seed for the train subset of the pro.college.pure dataset and uses that subset to apply the tree algorithim and plot. No pruning by cross-validation needed in this instance.


```{r}
MOD1a <- lm(MPG~cRPG, data = pro.college.pure)
anova(MOD1a)
# RSS = 2324.44

MOD1b <- lm(MPG~cAPG, data = pro.college.pure)
anova(MOD1b)
# RSS = 2070.7

MOD1c <- lm(MPG~cFGA, data = pro.college.pure)
anova(MOD1c)
# RSS = 2440.96

MOD1d <- lm(MPG~cFGp, data = pro.college.pure)
anova(MOD1d)
# RSS = 2178.41

MOD1e <- lm(MPG~cPPG, data = pro.college.pure)
anova(MOD1e)
# RSS = 2462.14

MOD1f <- lm(MPG~cMPG, data = pro.college.pure)
anova(MOD1f)
# RSS = 2407.75
```

First step of forward selection: testing each explanatory variable in a simple regression format and comaring residual sum of squares (RSS). cAPG determined to be the first variable in the model.


```{r}
MOD2a <- lm(MPG~cAPG + cFGA, data = pro.college.pure)
anova(MOD2a)

MOD2b <- lm(MPG~cAPG + cPPG, data = pro.college.pure)
anova(MOD2b)

MOD2c <- lm(MPG~cAPG + cFGM, data = pro.college.pure)
anova(MOD2c)

MOD2d <- lm(MPG~cAPG + cMPG, data = pro.college.pure)
anova(MOD2d)

MOD2e <- lm(MPG~cAPG + cRPG, data = pro.college.pure)
anova(MOD2e)

MOD2f <- lm(MPG~cAPG + cFGp, data = pro.college.pure)
anova(MOD2f)
```

Second step of forward selection: No other variables determined to be significant.
